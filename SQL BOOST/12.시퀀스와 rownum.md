# 시퀀스와 rownum
## 시퀀스 객체
- 차례대로 증가하는 숫자 값을 얻을 경우 매우 편리, 성능도 좋음
- 특정 데이틀에 pk 값으로 자주 사용.
  - pk 값 부여 과정에서 성능을 향상하거나 모델을 단순화.
  - 무조건적인 시퀀스 사용은 좋지 않고, 명확하고 간단한 pk 후보가 있다면 해당 컬럼을 pk로 잡아주는 것이 좋음.
  - 컬럼들이 너무 많아지거나, pk 값 처리 성능이 걱정된다면 시퀀스 값을 pk로 사용하는 것을 고려해야 함.

#### 주의할 점
- 테이블에 부여한 시퀀스 값에 구멍이 빠질 수 있음.
  - 1, 2, 4와 같이 중간에 값이 없는 것을 뜻 함.
```
1. 시퀀스 객체의 NEXTVAL을 이용해 시퀀스값을 발급 받음(여기서는 9를 발급받음)
2. 발급받은 시퀀스 값을 이용해 테이블 insert
3. insert 처리 중 어떤 오류로 인해 트랜잭션을 롤백 처리
    - newSeq=9는 테이블에 저장되지 못한 채 사라짐
    - 다시 NEXTVAL을 하면 9가 아닌 10이 나옴
```
- 시퀀스 값이 절대적으로 연속해야하는 업무 요건에는 시퀀스를 사용할 수 없음.
- 시퀀스 값이 절대적으로 비어서는 안된다고 요청한다면, 동시성 이슈가 심각합을 알려주고 협의를 해야함.

#### NEXTVAL과 CURRVAL
- MY_SEQ.NEXTVAL: MY_SEQ 시퀀스 객체의 다음 값을 가져옴.
- MY_SEQ.CURRVAL: 현 세션에서 최종 사용한 MY_SEQ.NEXTVAL 값을 가져옴.(NEXTVAL 후 사용 가능)

#### 옵션
- START WIHT N: 시퀀스의 시작 값을 설정
- INCREMENT BY N: 시퀀스의 증가 값을 설정 
- MAXVALUE N : 최대값을 설정
- MINVALUE N : 최솟값을 설정
- CYCLE N | NOCYCLE : 최대값 도달 후 순환 여부
- CACHE N | NOCACHE : 캐시 설정(n만큼 캐시에서 시퀀스를 미리 생성)
- ORDER | NOORDER : RAC(Real Application Clusters) 환경에서 시퀀스의 정렬 순서 보장 여부

성능에서 중요한 것은 cache와 order임.
</br>
cache 100으로 하면 시퀀스 객체는 100개의 시퀀스 값을 미리 메모리에 생성한 후 시퀀스 요청을 메모리에서 처리
</br>
order는 RAC 환경에서 시퀀스의 값을 차례대로 처리할 것인지 여부.
</br>
order로 설정하면 RAC 환경에서 성능 저하가 발생. 일반적으로 noorder로 시퀀스를 구성

```sql
CREATE SEQUENCE SQ_T_ACC_TRN
START WITH 1
INCREMENT BY 1
MAXVALUE 9999999999999999999999
NOCYCLE
CACHE 20
NOORDER
```
- 시퀀스 객체에 NEXTVAL을 호출하면 자동으로 시퀀스의 다음 값을 받아옴.
```sql
DECLARE
    v_NEW_ACC_TRN_SEQ NUMBER(18);
BEGIN

    v_NEW_ACC_TRN_SEQ := SQ_T_ACC_TRN.NEXTVAL();

    INSERT INTO T_ACC_TRN
    (ACC_TRN_SEQ ,FR_ACC_NO ,TO_ACC_NO ,TRN_AMT ,TRN_HND_ST ,TRN_ERR_CD ,TRN_REQ_DT ,TRN_CMP_DT)
    VALUES(v_NEW_ACC_TRN_SEQ ,'ACC1' ,'ACC3' ,500 ,'REQ' ,NULL ,SYSDATE ,NULL);

    COMMIT;

END;
```

