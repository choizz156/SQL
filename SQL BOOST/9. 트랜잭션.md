# 트랜잭션
## 트랜잭션이란?
- 쪼개서 실행할 수 없는 작업의 최소 단위.
- 여러 개의 sql로 구성될 수 있음.
### commit과 rollback
- 모든 작업이 한 번에 실행되거나, 아예 실행되지 않아야함(`원자성`).
- rollback시 논리적(업무적)으로 인해 진행해서는 안되는 상황일 수 있음.
  - B계좌가 존재하지 않는 상태에서 B계좌 잔액을 update하는 경우 등등
    - 이 경우 계좌에서 금액을 차감해서는 안 됨.
  - 업무적인 점검 로직을 추가해서 트랜잭션을 rollback함.
```
[트랜잭션 시작]
       │
       ▼
┌───────────────┐
│ A 계좌 -100원   │
└───────────────┘
       │
       ▼
┌───────────────┐
│  B 계좌 +100원  │
└───────────────┘
       │
       ├───────────▶ [성공] → **commit** 💾 (변경사항 저장)
       │
       ▼
[오류 발생?] ────▶ [실패] → **rollback** 🔄 (변경사항 취소)
```
### commit을 잘 못 사용한 예
- 부정확한 데이터가 만들어질 수 있음.
  - rollback을 할 상황에 commit을 수행하는 경우
- <u>sql 문장에서 에러가 발생한다고 해서</u>  <mark>데이터베이스는 전체 트랜잭션을 rollback하지 않음.</mark>
- <mark>반드시 명시적으로  rollback을 실행해야 함.</mark>

### 트랜잭션의 시작과 끝
- 데이터 변경이 sql이 실행되는 순간 시작
- 시작된 트랜잭션은 commit이나 rollback을 만나기 전까지 유지
- commit이나 rollback을 만난 후, 새로운 변경 sql이 실행되면, 그 후에  새로운 트랜잭션이(다른 sql들) 시작됨.

## 트랜잭션 테스트
### 정상적인 계좌 이체
- acc1에는 3000, acc2는 500원
```sql
update m_acc t1
set t1.bal_amt = t1.bal_amt - 500
where t1.acc_no = 'acc1';

update m_acc t1
set t1.bal_amt = t1.bal_amt + 500
where t1.acc_no = 'acc2';

commit;
```

|  acc1 | 1번계좌  | 2500  |
|---|---|---|
| acc2  | 2번계좌  |  1000 |
| acc3  | 3번계좌  |  0 |

### 비정상적인 계좌이체 - 수신 계좌가 없는 경우
- acc1에서만 500원이 사라짐.
- acc4는 계좌가 없음.
```sql
update m_acc t1
set t1.bal_amt = t1.bal_amt - 500
where t1.acc_no = 'acc1';

update m_acc t1
set t1.bal_amt = t1.bal_amt + 500
where t1.acc_no = 'acc4';

rollback;
```

|  acc1 | 1번계좌  | 2500 |
|---|---|------|
| acc2  | 2번계좌  | 1000 |
| acc3  | 3번계좌  | 0    |

### 비정상적인 계좌이체 - 이체 금액이 잔액보다 큰 경우
```sql
update m_acc t1
set t1.bal_amt = t1.bal_amt - 5000
where t1.acc_no = 'acc1';

update m_acc t1
set t1.bal_amt = t1.bal_amt + 5000
where t1.acc_no = 'acc3';

select *
from m_acc;

rollback;
```
- acc1의 잔액이 -2500이 됨.

### 트랜잭션 중에 에러가 발생한 경우
```sql
insert into m_acc(acc_no, acc_nm, bal_amt) values ('acc4','4번계좌',0);
insert into m_acc(acc_no, acc_nm, bal_amt) values ('acc1','1번계좌',0);    
-- ORA-00001: unique constraint (ORA_SQL_TEST. PK_M_ACC) violated 발생

select *
from m_acc;
```
-  unique constraint 오류가 발생했지만, 에러가 발생했다고 해서 틀랜잭션 전체가 자동 rollback 되는 것은 아니기 때문에 'acc4'계좌는 생성됨.


| acc1 | 1번계좌 | 2500 |
|------|------|------|
| acc2 | 2번계좌 | 1000 |
| acc3 | 3번계좌 | 0    |
| acc4 | 4번계좌 |0|

### 정리
- 트랜잭션은 한 번에 이루어져야 하는 작업 단위.
- 트랜잭션은 commit이나 rollback으로 종료가 이루어짐.
- commit으로 종료될 경우, 트랜잭션에서 변경된 데이터들은 모두 db에 반영
- rollback으로 종료될 경우, 틀랜잭션 시작 이전으로 데이터들은 복구
- 트랜잭션 내에서 에러가 발생했다고 해서 자동으로 rollback이 수행되지 않음.